<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste Pluggy Link</title>
  <script src="https://cdn.pluggy.ai/pluggy-link/v3/pluggy-link.js" defer></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { font-size: 18px; padding: 10px 20px; }
    pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>ğŸ”— Teste da API Pluggy</h2>
  <button id="btnConectar">Conectar Conta BancÃ¡ria</button>
  <h3>ğŸ“‹ TransaÃ§Ãµes:</h3>
  <pre id="resultado">Nenhuma transaÃ§Ã£o ainda.</pre>

  <script defer>
    window.onload = () => {
      const clientId = "fd905adc-6c7a-4bff-8564-0d1335785c6f";
      const clientSecret = "a89d5902-587f-4a45-b9a6-3101a517d2c5";

      async function gerarUserToken() {
        const response = await fetch("https://api.pluggy.ai/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId, clientSecret }),
        });
        if (!response.ok) throw new Error("Erro ao gerar userToken");
        const data = await response.json();
        return data.userToken;
      }

      async function buscarContas(itemId) {
        const response = await fetch(`https://api.pluggy.ai/accounts?itemId=${itemId}`);
        const data = await response.json();
        return data.results[0]?.id;
      }

      async function buscarTransacoes(accountId) {
        const response = await fetch(`https://api.pluggy.ai/transactions?accountId=${accountId}&pageSize=10`);
        const data = await response.json();
        return data.results;
      }

      document.getElementById("btnConectar").onclick = async () => {
        const resultado = document.getElementById("resultado");
        resultado.textContent = "ğŸ”„ Conectando...";

        try {
          const userToken = await gerarUserToken();

          const link = new PluggyLink({
            connectToken: userToken,
            onSuccess: async (item) => {
              resultado.textContent = "âœ… Conta conectada. Buscando transaÃ§Ãµes...";
              const accountId = await buscarContas(item.id);
              const transacoes = await buscarTransacoes(accountId);

              resultado.textContent = transacoes.map(tx =>
                `${tx.date} - ${tx.description} - R$ ${tx.amount.toFixed(2)}`
              ).join("\n") || "Nenhuma transaÃ§Ã£o encontrada.";
            },
            onError: (err) => {
              alert("Erro na conexÃ£o: " + err.message);
              resultado.textContent = "Erro na conexÃ£o.";
            }
          });

          link.open();
        } catch (e) {
          alert("Erro: " + e.message);
          resultado.textContent = "âŒ Erro: " + e.message;
        }
      };
    };
  </script>
</body>
</html>
