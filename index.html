<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste Pluggy Link</title>
  <!-- SDK Pluggy Link - Removido o defer -->
  <script src="https://cdn.pluggy.ai/pluggy-link/v3/pluggy-link.js"></script>
  <style>
    body { font-family: Arial; padding: 30px; }
    button { padding: 10px 20px; font-size: 18px; }
    pre { margin-top: 20px; padding: 10px; background: #f9f9f9; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>🔗 Teste da API Pluggy</h2>
  <button id="btnConectar">Conectar Conta Bancária</button>
  <pre id="resultado">Nenhuma transação carregada.</pre>

  <script>
    // Removido o defer e colocado o código diretamente
    document.addEventListener('DOMContentLoaded', () => {
      const clientId = "fd905adc-6c7a-4bff-8564-0d1335785c6f";
      const clientSecret = "a89d5902-587f-4a45-b9a6-3101a517d2c5";

      async function gerarUserToken() {
        const response = await fetch("https://api.pluggy.ai/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId, clientSecret })
        });
        if (!response.ok) throw new Error("Erro ao gerar userToken");
        const data = await response.json();
        return data.userToken;
      }

      async function buscarContas(itemId) {
        const res = await fetch(`https://api.pluggy.ai/accounts?itemId=${itemId}`);
        const data = await res.json();
        return data.results[0]?.id;
      }

      async function buscarTransacoes(accountId) {
        const res = await fetch(`https://api.pluggy.ai/transactions?accountId=${accountId}&pageSize=10`);
        const data = await res.json();
        return data.results;
      }

      const btn = document.getElementById('btnConectar');
      const resultado = document.getElementById('resultado');

      btn.onclick = async () => {
        resultado.textContent = "🔄 Conectando...";
        try {
          const userToken = await gerarUserToken();

          // Verifica se o PluggyLink está disponível
          if (typeof window.PluggyLink === 'undefined') {
            resultado.textContent = "❌ ERRO: PluggyLink não carregado. Recarregue a página.";
            return;
          }

          const pluggyLink = new window.PluggyLink({
            connectToken: userToken,
            onSuccess: async (item) => {
              resultado.textContent = "🔍 Conta conectada. Carregando transações...";
              const accountId = await buscarContas(item.id);
              const transacoes = await buscarTransacoes(accountId);
              resultado.textContent = transacoes.map(tx =>
                `${tx.date} - ${tx.description} - R$ ${tx.amount.toFixed(2)}`
              ).join("\n") || "Nenhuma transação encontrada.";
            },
            onError: (err) => {
              resultado.textContent = "❌ Erro: " + err.message;
            }
          });

          pluggyLink.open();
        } catch (e) {
          resultado.textContent = "❌ Erro geral: " + e.message;
        }
      };
    });
  </script>
</body>
</html>
